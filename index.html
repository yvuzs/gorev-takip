<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Görev Takibi</title>
<link rel="manifest" href="./manifest.webmanifest">
<style>
body {
  font-family: system-ui, sans-serif;
  background: #0f1624;
  color: #fff;
  margin: 0; padding: 0;
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100vh;
}
.card {
  background: #161d2e;
  border-radius: 16px;
  padding: 1rem 1.5rem;
  margin: 1rem;
  box-shadow: 0 0 10px #0004;
}
button {
  border: none; border-radius: 8px;
  padding: .5rem 1rem;
  cursor: pointer; font-weight: 500;
}
#toast {
  position: fixed; bottom: 1rem; right: 1rem;
  background: #222c; color: #fff;
  padding: .5rem 1rem; border-radius: 6px;
  opacity: 0; transition: opacity .4s;
}
#toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="card" style="width:260px;">
  <h2>Yeni Kayıt</h2>
  <label>Görev Türü</label><br>
  <input id="taskType" list="typeList" placeholder="Tür seç"><br>
  <datalist id="typeList"></datalist>
  <br>
  <label>Kişi</label><br>
  <input id="person" list="personList" placeholder="Personel"><br>
  <datalist id="personList"></datalist>
  <br>
  <button onclick="addRecord()">Kaydı Ekle</button>
  <hr>
  <button onclick="exportJSON()">Dışa Aktar (JSON)</button>
  <button onclick="importJSON()">İçe Aktar</button>
  <hr>
  <button onclick="resetAll()" style="background:#c33;color:#fff">Tüm Veriyi Sıfırla</button>
</div>

<div class="card" style="flex:1;">
  <h2>Özet Tablo</h2>
  <div id="records"></div>
</div>

<button id="installBtn" style="position:fixed;bottom:1rem;left:1rem;background:#4b9;color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;display:none;">Telefonuma Yükle</button>

<div id="toast"></div>

<script>
/* ====== Uygulama verisi ====== */
let state = { people: [], types: [], records: [] };
const CLOUD_API_URL = "https://script.google.com/macros/s/AKfycbyTlgwK6b1P4w2m1u2yTTTJNz63w8MJ2RTBPTeQeOcQrmptZtVN8_u_doR1WTSXJPSd/exec";

/* ====== Local Storage ====== */
function save(){ localStorage.setItem('gorevData', JSON.stringify(state)); }
function load(){
  const s = localStorage.getItem('gorevData');
  if(s) state = JSON.parse(s);
}

/* ====== Arayüz ====== */
function render(){
  document.getElementById('personList').innerHTML = state.people.map(p=>`<option>${p}</option>`).join('');
  document.getElementById('typeList').innerHTML = state.types.map(t=>`<option>${t}</option>`).join('');
  document.getElementById('records').innerHTML =
    state.records.length ?
      `<ul>${state.records.map(r=>`<li>${r.type} → ${r.person}</li>`).join('')}</ul>` :
      "<i>Henüz kayıt yok</i>";
}

/* ====== Kayıt işlemleri ====== */
function addRecord(){
  const t = document.getElementById('taskType').value.trim();
  const p = document.getElementById('person').value.trim();
  if(!t||!p) return toast("Lütfen tür ve kişi gir.");
  if(!state.types.includes(t)) state.types.push(t);
  if(!state.people.includes(p)) state.people.push(p);
  state.records.push({type:t, person:p, date:Date.now()});
  save(); render(); schedulePush("ekleme");
}
function resetAll(){
  if(confirm("Tüm veriler silinsin mi?")){
    state = {people:[], types:[], records:[]};
    save(); render(); schedulePush("sıfırlama");
  }
}

/* ====== Dışa/İçe aktar ====== */
function exportJSON(){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)], {type:"application/json"}));
  a.download = "gorevData.json"; a.click();
}
function importJSON(){
  const i = document.createElement('input'); i.type="file"; i.accept=".json";
  i.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    f.text().then(t=>{
      try{ state = JSON.parse(t); save(); render(); schedulePush("içe aktarım"); }
      catch{ toast("Geçersiz JSON"); }
    });
  };
  i.click();
}

/* ====== Bulut Senkron (Apps Script) ====== */
async function cloudPush(){
  const res = await fetch(CLOUD_API_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({data:state})
  });
  const j = await res.json();
  if(!res.ok||!j.ok) throw new Error(j.error||('HTTP '+res.status));
  return true;
}
async function cloudPull(){
  const res = await fetch(CLOUD_API_URL);
  const j = await res.json();
  if(!res.ok||!j.ok) throw new Error(j.error||('HTTP '+res.status));
  if(j.data){ state=j.data; save(); render(); }
}
let pushDebounce=null;
function schedulePush(reason=''){
  if(pushDebounce) clearTimeout(pushDebounce);
  pushDebounce=setTimeout(async()=>{
    try{ await cloudPush(); toast('Buluta eşitlendi'+(reason?' • '+reason:''),true); }
    catch(e){ console.error(e); toast('Senkron hatası: '+e.message,false); }
    finally{ pushDebounce=null; }
  },600);
}

/* ====== Yardımcılar ====== */
function toast(msg, ok){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=ok?'#2b4':'#c33';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

/* ====== Başlat ====== */
load(); render();
(async()=>{ try{ await cloudPull(); toast('Buluttan çekildi',true);}catch(e){} })();

/* ====== PWA / Service Worker ====== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js',{scope:'./'}));
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault(); deferredPrompt=e;
  document.getElementById('installBtn').style.display='block';
});
document.getElementById('installBtn').onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const {outcome}=await deferredPrompt.userChoice;
  if(outcome==='accepted') toast('Uygulama yüklendi',true);
  deferredPrompt=null;
};
</script>
</body>
</html>
