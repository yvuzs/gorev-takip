<!doctype html>
<html lang="tr">
<head>
    <!doctype html>
    <html lang="tr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Görev Takibi (PWA + Otomatik Senkron) v17</title>
        <link rel="manifest" href="manifest.webmanifest">
        <meta name="theme-color" content="#0b1220">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon" href="icons/icon-192.png">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <style>
            :root {
                --bg: #0f172a;
                --panel: #111827;
                --muted: #94a3b8;
                --chip: #1f2937;
                --accent2: #3b82f6;
            }

            * { box-sizing: border-box }
            body {
                margin: 0;
                font: 14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;
                background: var(--bg);
                color: #e5e7eb
            }
            .wrap { max-width: 1200px; margin: auto; padding: 24px }
            h1 { margin: 0 0 10px; font-weight: 800; font-size: 22px; text-align: center }
            .grid { display: grid; grid-template-columns: 340px 1fr; gap: 16px }
            .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25) }

            label { display:block; margin:10px 0 6px; color:#cbd5e1; font-weight:600 }
            input[type=text], input[type=date], select {
                width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155;
                background:#0b1220; color:#e5e7eb; text-align:center
            }
            .row { display:flex; gap:8px; align-items:center }
            .row.between { justify-content: space-between }
            .row > * { flex:1 }
            .btn { padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; cursor:pointer; text-align:center }
            .btn.small { padding:4px 8px; font-size:12px; border-radius:999px }
            .btn:hover { filter:brightness(1.15) }
            .btn-prim { background: linear-gradient(135deg,#3b82f6,#06b6d4); border:0; color:white }
            .btn-good { background: linear-gradient(135deg,#22c55e,#16a34a); border:0; color:white }
            .btn-danger { background: linear-gradient(135deg,#ef4444,#f97316); border:0; color:white }
            .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; background:var(--chip); border:1px solid #334155 }
            .muted { color: var(--muted) }
            table { width:100%; border-collapse:collapse; text-align:center }
            th, td { padding:8px 10px; border-bottom:1px solid #1f2937; vertical-align:middle }
            th { position:sticky; top:0; background:#0b1220; font-size:12px; text-transform:uppercase; letter-spacing:.04em }
            tbody tr:hover { background:#0b1220 }
            .kbadge { font-weight:700; padding:2px 6px; border-radius:8px; background:#1e293b; display:inline-block }
            .pill { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #334155; display:inline-block }
            .stack { display:flex; flex-wrap:wrap; gap:8px; justify-content:center }
            .small { font-size:12px }
            .right { display:flex; gap:8px; justify-content:flex-end }
            details { border:1px dashed #334155; border-radius:12px; padding:10px }
            summary { cursor:pointer; color:#93c5fd }

            .score-picker { display:flex; gap:6px; justify-content:center; margin-top:6px }
            .score-box { width:40px; height:24px; border-radius:6px; border:1px solid #444; cursor:pointer; opacity:.85; transition:transform .12s,opacity .12s,box-shadow .12s }
            .score-box:hover { opacity:1; transform:translateY(-1px) }
            .score-box.active { box-shadow:0 0 0 2px #fff inset; opacity:1; transform:translateY(-1px) }
            .score-label { display:block; margin-top:6px; text-align:center; color:#cbd5e1 }

            .tab-group { display:flex; gap:6px }
            .tab-btn { border:1px solid #334155; background:#0b1220; color:#cbd5e1; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer }
            .tab-btn.active { background:#2563eb; color:#fff; border-color:#2563eb }

            @media (max-width:900px) {
                .grid { grid-template-columns: 1fr }
                .wrap { padding:16px }
                .card { padding:14px }
                h1 { font-size:20px }
                #digerInline .row { flex-direction:column; align-items:stretch }
                #digerInline .row > * { width:100% }
            }

            .row.compact { gap:6px; align-items:center; }
            #digerInline select { min-width:140px; }
            @media (max-width:900px) {
                .row { flex-wrap:wrap; }
                #digerInline select { width:100%; }
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <h1>Görev Takibi</h1>
            <div class="grid">
                <div class="card">
                    <h2>Yeni Kayıt</h2>
                    <div class="row">
                        <div>
                            <label>Görev Türü</label>
                            <select id="taskType"></select>
                        </div>
                        <div>
                            <label>Kişi <span class="muted small" id="suggestHint"></span></label>
                            <select id="personSelect"></select>
                        </div>
                        <div id="digerInline" style="display:none">
                            <label>Alt Kategori (DİĞER)</label>
                            <div class="row compact">
                                <select id="digerTaskSelectTop"></select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label>Başlangıç Tarihi</label>
                            <input id="startDate" type="date" />
                        </div>
                        <div>
                            <label>Bitiş Tarihi (opsiyonel)</label>
                            <input id="endDate" type="date" />
                        </div>
                    </div>
                    <div id="otherWrap" style="display:none">
                        <label>Puan (1–5) & Açıklama</label>
                        <div class="score-picker" id="scorePicker">
                            <div class="score-box" data-val="1" style="background:#fff7b2"></div>
                            <div class="score-box" data-val="2" style="background:#ffe44d"></div>
                            <div class="score-box" data-val="3" style="background:#ffd32d"></div>
                            <div class="score-box" data-val="4" style="background:#ffa64d"></div>
                            <div class="score-box" data-val="5" style="background:#e82929"></div>
                        </div>
                        <span class="score-label" id="scoreLabel">Seçili: 1</span>
                        <input id="pointsInput" type="hidden" value="1" />
                        <div class="row" style="margin-top:8px">
                            <input id="noteInput" type="text" placeholder="Açıklama (opsiyonel)" />
                        </div>
                    </div>
                    <label>Atama Stratejisi</label>
                    <div class="stack small" id="modeRadios">
                        <label class="chip"><input type="radio" name="mode" value="rr"> Round-Robin</label>
                        <label class="chip"><input type="radio" name="mode" value="min" checked> En az görev yapan</label>
                        <label class="chip"><input type="radio" name="mode" value="idle"> En uzun süredir görev almayan</label>
                    </div>
                    <div class="row">
                        <button class="btn btn-good" id="btnSuggest">Sıradaki Öner</button>
                        <button class="btn btn-prim" id="btnAdd">Kaydı Ekle</button>
                    </div>
                    <details>
                        <summary>Personel ve Tür Listeleri</summary>
                        <div class="row"><input id="newPerson" type="text" placeholder="Yeni personel adı" /><button class="btn" id="btnAddPerson">Ekle</button></div>
                        <div class="stack" id="peopleChips"></div>
                        <label>Görev Türleri</label>
                        <div class="stack" id="typeChips"></div>
                        <div class="row"><input id="newType" type="text" placeholder="Yeni tür (ör. GAMER)" /><button class="btn" id="btnAddType">Ekle</button></div>
                        <summary style="margin-top:20px">DİĞER – görev ve personel listelerini düzenle</summary>
                        <label>DİĞER Görevleri</label>
                        <div class="stack" id="digerTaskChips"></div>
                        <div class="row"><input id="digerTaskNew2" type="text" placeholder="Yeni DİĞER görevi"><button class="btn" id="btnAddDigerTask2">Ekle</button></div>
                        <label style="margin-top:10px">Personel (kısa yol)</label>
                        <div class="stack" id="peopleChips2"></div>
                    </details>
                    <details open>
                        <summary>Bulut Ayarı</summary>
                        <label>Cloudflare Worker URL</label>
                        <input id="cloudUrl" type="text" placeholder="https://<worker-adresin>.workers.dev/" />
                        <p class="muted small">Değişiklikler otomatik olarak buluta gönderilir ve arka planda çekilir.</p>
                    </details>
                    <div class="row">
                        <button class="btn" id="btnExport">Dışa Aktar (JSON)</button>
                        <button class="btn" id="btnImport">İçe Aktar</button>
                        <input type="file" id="fileImport" accept="application/json" style="display:none" />
                    </div>
                    <div class="right"><button class="btn btn-danger" id="btnReset">Tüm Veriyi Sıfırla</button></div>
                </div>
                <div class="card">
                    <div class="row between" style="align-items:center;margin-bottom:8px">
                        <h2 style="margin:0">Özet Tablo</h2>
                        <div class="tab-group" role="tablist" aria-label="Tablolar">
                            <button id="tabSummary" class="tab-btn active" role="tab" aria-selected="true">Özet</button>
                            <button id="tabDiger" class="tab-btn" role="tab" aria-selected="false">DİĞER</button>
                        </div>
                    </div>
                    <div id="summaryWrap" style="overflow:auto; max-height:420px"><table id="summaryTable"></table></div>
                    <div id="digerWrap" style="display:none; overflow:auto; max-height:420px">
                        <table id="digerTable"></table>
                    </div>
                    <h3 style="text-align:center">Kayıtlar</h3>
                    <div id="logWrap" style="overflow:auto; max-height:260px"><table id="logTable"></table></div>
                </div>
            </div>
        </div>

        <script>
        (function(){
            const LS_KEY = 'gorevTakip_v11';       // v16 ile aynı anahtar
            const OTHER_TYPE = 'DIGER';
            const daysWeighted = new Set(["112-HABER MERKEZI", "GAMER"]);
            const $ = s => document.querySelector(s);
            const today = () => new Date().toISOString().slice(0,10);
            const DEFAULT_WORKER = 'https://blue-violet-32c9.retkitselim.workers.dev/';
            const UI_KEY = LS_KEY + '__ui';

            function ensureClientId(){ let id = localStorage.getItem(LS_KEY+'__clientId'); if(!id){ id='c-'+Math.random().toString(36).slice(2)+Date.now(); localStorage.setItem(LS_KEY+'__clientId', id);} return id; }
            const CLIENT_ID = ensureClientId();

            let state;
            try { state = JSON.parse(localStorage.getItem(LS_KEY) || 'null') } catch { state = null }
            if(!state){
                state = {
                    people:["ATAL","KAVAKLI","YAMAN","AKSU","GORMEZ","TURGAY","ERDIK","SAGLAM"],
                    types:["112-HABER MERKEZI","GAMER","MAC","GOCMEN","DIGER"],
                    digerTasks:["GOREV1","GOREV2"],
                    records:[],
                    lastByType:{},
                    lastByOtherTask:{},
                    __meta:{updatedAt:Date.now(), clientId: CLIENT_ID}
                };
            } else {
                state.__meta = state.__meta || {updatedAt:Date.now(), clientId: CLIENT_ID};
                state.digerTasks = state.digerTasks || ["GOREV1","GOREV2"];
                state.lastByOtherTask = state.lastByOtherTask || {};
            }
            const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state));
            const bumpMeta = () => { state.__meta = {updatedAt:Date.now(), clientId: CLIENT_ID}; };

            function weightOfRecord(r){
  // Gün sayısı (start–end arası), en az 1
  const s = new Date(r.start);
  const e = new Date(r.end || r.start);
  let days = Math.ceil((e - s) / 86400000);
  if (!isFinite(days) || days < 1) days = 1;

  const T = (r.type || '').toUpperCase();
  const isOther = T === (OTHER_TYPE || '').toUpperCase() || T === 'DİĞER' || T === 'DIGER';

  if (isOther) {
    const pts = Number(r.points || 0);
    // İSTENEN: tarih aralığı gün sayısı + (varsa) puan
    return days + (pts > 0 ? pts : 0);
  }

  // Diğer bazı türler günle ağırlanıyorsa koru (sende vardı)
  if (typeof daysWeighted !== 'undefined' && daysWeighted.has(r.type)) {
    return days;
  }

  // Varsayılan
  return 1;
}

            function countsBy(type){
                const m = new Map(state.people.map(p=>[p,0]));
                state.records.forEach(r=>{ if(!type || r.type===type){ m.set(r.person, (m.get(r.person)||0) + weightOfRecord(r)); } });
                return m;
            }
            function lastTimeBy(type){
                const m = new Map(state.people.map(p=>[p,0]));
                state.records.forEach(r=>{ if(!type || r.type===type){ const t=new Date(r.start).getTime(); if(t>m.get(r.person)) m.set(r.person,t);} });
                return m;
            }
            // --- per DİĞER görev yardımcıları ---
            function countsByOtherTask(task){
                const m = new Map(state.people.map(p=>[p,0]));
                state.records.forEach(r=>{
                    if(r.type===OTHER_TYPE && r.digerTask===task){
                        m.set(r.person, (m.get(r.person)||0) + weightOfRecord(r));
                    }
                });
                return m;
            }
            function lastTimeByOtherTask(task){
                const m = new Map(state.people.map(p=>[p,0]));
                state.records.forEach(r=>{
                    if(r.type===OTHER_TYPE && r.digerTask===task){
                        const t=new Date(r.start).getTime(); if(t>m.get(r.person)) m.set(r.person,t);
                    }
                });
                return m;
            }
            function nextRRForTask(task){
                const list = state.people; if(!list.length) return null;
                const last = state.lastByOtherTask[task];
                let idx = last ? list.indexOf(last) : -1;
                return list[(idx+1) % list.length];
            }
            function nextMinForTask(task){
                const c = countsByOtherTask(task); let best=null, bv=Infinity;
                for(const p of state.people){ const v=c.get(p)||0; if(v<bv){ best=p; bv=v; } }
                return best;
            }
            function nextIdleForTask(task){
                const m = lastTimeByOtherTask(task); let best=null, bv=Infinity;
                for(const p of state.people){ const v=m.get(p)||0; if(v<bv){ best=p; bv=v; } }
                return best;
            }

            function nextRR(type){
                const list=state.people; if(!list.length) return null;
                const last = state.lastByType[type]; let idx = last ? list.indexOf(last) : -1;
                return list[(idx+1)%list.length];
            }
            function nextMin(type){
                const c=countsBy(type); let best=null,bv=Infinity;
                for(const p of state.people){ const v=c.get(p)||0; if(v<bv){ best=p; bv=v; } }
                return best;
            }
            function nextIdle(type){
                const m=lastTimeBy(type); let best=null,bv=Infinity;
                for(const p of state.people){ const v=m.get(p)||0; if(v<bv){ best=p; bv=v; } }
                return best;
            }

            // öneri: type=DIGER ise seçilen alt kategoriye göre
            function suggest(type){
                if(type===OTHER_TYPE){
                    const selTop = document.querySelector('#digerTaskSelectTop');
                    const task = selTop ? selTop.value : (state.digerTasks[0]||null);
                    const mode = document.querySelector('input[name=mode]:checked').value;
                    if(!task) return null;
                    if(mode==='rr') return nextRRForTask(task);
                    if(mode==='idle') return nextIdleForTask(task);
                    return nextMinForTask(task);
                }
                const mode = document.querySelector('input[name=mode]:checked').value;
                if(mode==='rr') return nextRR(type);
                if(mode==='idle') return nextIdle(type);
                return nextMin(type);
            }

            let currentView = (JSON.parse(localStorage.getItem(UI_KEY) || '{}').view) || 'summary';
            function setView(v){
                currentView = v;
                localStorage.setItem(UI_KEY, JSON.stringify({view:v}));
                const isDiger = (v==='diger');
                $('#summaryWrap').style.display = isDiger ? 'none':'block';
                $('#digerWrap').style.display = isDiger ? 'block':'none';
                $('#tabSummary').classList.toggle('active', !isDiger);
                $('#tabSummary').setAttribute('aria-selected', String(!isDiger));
                $('#tabDiger').classList.toggle('active', isDiger);
                $('#tabDiger').setAttribute('aria-selected', String(isDiger));
            }
            function toggleOtherInputs(){
                const show = $('#taskType').value===OTHER_TYPE;
                $('#otherWrap').style.display = show ? 'block':'none';
                $('#digerInline').style.display = show ? 'block':'none';
                if(show){
                    const selTop=$('#digerTaskSelectTop');
                    if(selTop && !selTop.value && state.digerTasks.length) selTop.value = state.digerTasks[0];
                    setView('diger');
                } else if(currentView==='diger'){ setView('summary'); }
            }
            function initScorePicker(){
                const boxes = document.querySelectorAll('#scorePicker .score-box');
                const hidden = $('#pointsInput'), label = $('#scoreLabel');
                boxes.forEach(b=>{
                    b.onclick=()=>{
                        boxes.forEach(x=>x.classList.remove('active'));
                        b.classList.add('active');
                        hidden.value=b.dataset.val; label.textContent='Seçili: '+hidden.value;
                    };
                });
                (boxes[0]||{}).click?.();
            }

            function renderSummary(){
                const types = state.types, tbl=$('#summaryTable');
                const head = '<thead><tr><th><span class="pill">PERSONEL</span></th>' + types.map(t=>`<th><span class="pill">${t}</span></th>`).join('') + '<th><span class="pill">TOPLAM</span></th></tr></thead>';
                const siraCells = types.map(t=>`<td><span class="pill">${suggest(t)||'-'}</span></td>`).join('');
                const siraRow = `<tr><td class="muted small">Sıra</td>${siraCells}<td></td></tr>`;
                const rows = state.people
                    .map(p=>{ const cells=types.map(t=>countsBy(t).get(p)||0); const tot=cells.reduce((a,b)=>a+b,0); return {p,cells,tot}; })
                    .sort((a,b)=>a.tot-b.tot)
                    .map(obj=>`<tr><td><span class="kbadge">${obj.p}</span></td>${obj.cells.map(c=>`<td>${c}</td>`).join('')}<td><b>${obj.tot}</b></td></tr>`)
                    .join('');
                tbl.innerHTML = head + '<tbody>' + siraRow + rows + '</tbody>';
            }

            function renderDiger(){
  // --- yardımcılar ---
  const isOther = r => {
    const t = (r.type || '').toUpperCase();
    return t === (OTHER_TYPE||'').toUpperCase() || t === 'DİĞER' || t === 'DIGER';
  };
  const w = r => (typeof weightOfRecord === 'function' ? weightOfRecord(r) : (Number(r.points)||1));

  // 1) TOPLAM DİĞER PUANINA göre personel sütun sırası
  const totals = new Map(state.people.map(p => [p, 0]));
  state.records.forEach(r => {
    if (isOther(r)) totals.set(r.person, (totals.get(r.person)||0) + w(r));
  });
  const orderedPeople = state.people.slice().sort((a,b)=>{
    const da = totals.get(a)||0, db = totals.get(b)||0;
    if (da !== db) return da - db;      // az solda, çok sağda
    return a.localeCompare(b);
  });

  // 2) Başlık
  const head = `<thead><tr>
      <th><span class="pill">DİĞER GÖREVLER</span></th>
      <th><span class="pill">SIRA</span></th>
      ${orderedPeople.map(p=>`<th><span class="pill">${p}</span></th>`).join('')}
    </tr></thead>`;

  // 3) Satırlar (her görev için)
  const bodyRows = state.digerTasks.map(task => {
    // görev özelinde öneri
    const mode = document.querySelector('input[name=mode]:checked').value;
    let next;
    if (mode==='rr') next = nextRRForTask(task);
    else if (mode==='idle') next = nextIdleForTask(task);
    else next = nextMinForTask(task);

    // hücreler: orderedPeople ile aynı sırada ve PUAN toplamı
    const cells = orderedPeople.map(p => {
      const sum = state.records.reduce((acc, r) => {
        if (isOther(r) && r.digerTask === task && r.person === p) {
          return acc + w(r);
        }
        return acc;
      }, 0);
      return `<td>${sum || 0}</td>`;
    }).join('');

    return `<tr>
      <td><span class="kbadge">${task}</span></td>
      <td><span class="pill">${next || '-'}</span></td>
      ${cells}
    </tr>`;
  }).join('');

  // 4) Tabloyu bas
  $('#digerTable').innerHTML = head + '<tbody>' + bodyRows + '</tbody>';

  // 5) (v17’deki ekle/sil UI’sini koru)
  const dc = $('#digerTaskChips'); dc.innerHTML = '';
  state.digerTasks.forEach(t=>{
    const wChip = document.createElement('span');
    wChip.className = 'chip';
    wChip.innerHTML = `<span>${t}</span>`;
    const del = document.createElement('button');
    del.className = 'btn small';
    del.textContent = 'Sil';
    del.onclick = ()=>{
      if(state.digerTasks.length<=1) return alert('En az bir DİĞER görevi kalmalı.');
      if(!confirm(`${t} silinsin mi?`)) return;
      state.digerTasks = state.digerTasks.filter(x=>x!==t);
      bumpMeta(); save(); renderAll(); if (typeof schedulePush==='function') schedulePush();
    };
    wChip.appendChild(del);
    dc.appendChild(wChip);
  });
  // önceki seçimi hatırla
const selBefore = ($('#digerTaskSelectTop') ? $('#digerTaskSelectTop').value : '') || '';

// options'ları yeniden yaz
const selEl = $('#digerTaskSelectTop');
selEl.innerHTML = state.digerTasks.map(t=>`<option>${t}</option>`).join('');

// mümkünse eski seçimi geri yükle; yoksa ilkini seç
if (selBefore && Array.from(selEl.options).some(o => o.value === selBefore)) {
  selEl.value = selBefore;
} else if (state.digerTasks.length) {
  selEl.value = state.digerTasks[0];
}

  const pc2 = $('#peopleChips2'); pc2.innerHTML='';
  state.people.forEach(p=>{
    const wChip = document.createElement('span');
    wChip.className='chip';
    wChip.innerHTML=`<span>${p}</span>`;
    const del=document.createElement('button');
    del.className='btn small';
    del.textContent='Sil';
    del.onclick = ()=>{ if(!confirm(`${p} silinsin mi?`)) return; state.people = state.people.filter(x=>x!==p); bumpMeta(); save(); renderAll(); if (typeof schedulePush==='function') schedulePush(); };
    wChip.appendChild(del); pc2.appendChild(wChip);
  });
}

            function renderListsAndLog(){
    // --- ÖNCEKİ SEÇİMLERİ HATIRLA ---
    const prevTypeEl   = document.querySelector('#taskType');
    const prevPersonEl = document.querySelector('#personSelect');
    const prevType     = prevTypeEl   ? prevTypeEl.value   : '';
    const prevPerson   = prevPersonEl ? prevPersonEl.value : '';

    // --- GÖREV TÜRÜ LİSTESİ ---
    const typeSelect = document.querySelector('#taskType');
    typeSelect.innerHTML = state.types.map(t=>`<option>${t}</option>`).join('');

    if (prevType && state.types.includes(prevType)) {
        typeSelect.value = prevType;          // önceki türü koru (örn: DIGER)
    } else if (state.types.length) {
        typeSelect.value = state.types[0];    // yoksa ilkini seç
    }

    // --- PERSONEL LİSTESİ ---
    const personSelect = document.querySelector('#personSelect');
    personSelect.innerHTML = state.people.map(p=>`<option>${p}</option>`).join('');

    if (prevPerson && state.people.includes(prevPerson)) {
        personSelect.value = prevPerson;      // önceki kişiyi koru
    } else if (state.people.length) {
        personSelect.value = state.people[0];
    }

    // --- TARİH ---
    if (!document.querySelector('#startDate').value) {
        document.querySelector('#startDate').value = today();
    }

    // --- PERSONEL CHIP'LERİ ---
    const pc = document.querySelector('#peopleChips'); 
    pc.innerHTML='';
    state.people.forEach(p=>{
        const w=document.createElement('span'); 
        w.className='chip'; 
        w.innerHTML=`<span>${p}</span>`;
        const d=document.createElement('button'); 
        d.className='btn small'; 
        d.textContent='Sil';
        d.onclick=()=>{
            if(!confirm(`${p} silinsin mi?`)) return;
            state.people = state.people.filter(x=>x!==p);
            bumpMeta(); save(); renderAll(); if (typeof schedulePush==='function') schedulePush();
        };
        w.appendChild(d); pc.appendChild(w);
    });

    // --- TÜR CHIP'LERİ ---
    const tc = document.querySelector('#typeChips'); 
    tc.innerHTML='';
    state.types.forEach(t=>{
        const w=document.createElement('span'); 
        w.className='chip'; 
        w.innerHTML=`<span>${t}</span>`;
        const d=document.createElement('button'); 
        d.className='btn small'; 
        d.textContent='Sil';
        d.onclick=()=>{
            if(state.types.length<=1) return alert('En az bir tür kalmalı.');
            if(!confirm(`${t} silinsin mi?`)) return;
            state.types = state.types.filter(x=>x!==t);
            bumpMeta(); save(); renderAll(); if (typeof schedulePush==='function') schedulePush();
        };
        w.appendChild(d); tc.appendChild(w);
    });

    // --- KAYIT TABLOSU ---
    const log=document.querySelector('#logTable');
    log.innerHTML =
      '<thead><tr>' +
      '<th><span class="pill">BAŞLANGIÇ</span></th>' +
      '<th><span class="pill">BİTİŞ</span></th>' +
      '<th><span class="pill">TÜR</span></th>' +
      '<th><span class="pill">KİŞİ</span></th>' +
      '<th><span class="pill">PUAN</span></th>' +
      '<th><span class="pill">AÇIKLAMA</span></th>' +
      '<th></th></tr></thead><tbody>' +
      state.records.slice().reverse().map((r,i)=>{
          const idx = state.records.length-1-i;
          const p   = (r.type===OTHER_TYPE) ? (r.points||'') : '';
          const note= (r.type===OTHER_TYPE) ? (r.note||'')   : '';
          return `<tr>
              <td>${r.start}</td>
              <td>${r.end}</td>
              <td>${r.type}${r.digerTask ? ` / ${r.digerTask}` : ''}</td>
              <td>${r.person}</td>
              <td>${p}</td>
              <td>${note}</td>
              <td><button class="btn small" data-del="${idx}">Sil</button></td>
          </tr>`;
      }).join('') + '</tbody>';

    log.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{
        const idx=+b.getAttribute('data-del');
        state.records.splice(idx,1);
        bumpMeta(); save(); renderAll(); if (typeof schedulePush==='function') schedulePush();
    });
}

            function renderAll(){
                localStorage.setItem(LS_KEY+'__cloud', JSON.stringify({url: $('#cloudUrl')?.value || ''}));
                renderListsAndLog();
                renderSummary();
                renderDiger();
                toggleOtherInputs();
                setView(currentView);
                // update suggestion hint if DIGER
                if($('#taskType').value===OTHER_TYPE) $('#btnSuggest').click();
            }

            // events
            $('#taskType').onchange = ()=>{ toggleOtherInputs(); $('#btnSuggest').click(); };
            $('#digerTaskSelectTop').addEventListener('change', ()=>{ $('#btnSuggest').click(); renderDiger(); });

            $('#btnSuggest').onclick = ()=>{
                const t = $('#taskType').value;
                const p = suggest(t);
                $('#suggestHint').textContent = p ? `(öneri: ${p})` : '';
                if(p) $('#personSelect').value = p;
            };

            $('#btnAdd').onclick = ()=>{
                const type=$('#taskType').value, person=$('#personSelect').value;
                const s=$('#startDate').value, e=$('#endDate').value;
                if(!type || !person || !s) return alert('Eksik bilgi');
                let end = e; if(!end){ const d=new Date(s); d.setDate(d.getDate()+1); end=d.toISOString().slice(0,10); }
                let days=Math.ceil((new Date(end)-new Date(s))/86400000); if(days<1) days=1;

                const rec = {type, person, start:s, end:end, days};
                if(type===OTHER_TYPE){
                    const selTop=$('#digerTaskSelectTop');
                    const chosen = (selTop && selTop.value || '').trim();
                    if(!chosen) return alert('DİĞER alt kategorisini seçin veya ekleyin.');
                    rec.digerTask = chosen;
                    rec.points = Math.max(1, Math.min(5, Number($('#pointsInput').value||'1')));
                    rec.note = ($('#noteInput').value||'').trim();
                    // round-robin izini görev bazında tut
                    state.lastByOtherTask[chosen] = person;
                    setView('diger');
                } else {
                    state.lastByType[type] = person;
                }

                state.records.push(rec);
                bumpMeta(); save(); renderAll(); schedulePush();
            };

            function addDigerTaskFrom(inputId){
                const v = document.querySelector(inputId).value.trim();
                if(v && !state.digerTasks.includes(v)){
                    state.digerTasks.push(v);
                    document.querySelector(inputId).value='';
                    bumpMeta(); save(); renderAll(); schedulePush();
                    const selTop=$('#digerTaskSelectTop'); if(selTop) selTop.value=v;
                }
            }
            document.getElementById('btnAddDigerTask2').onclick = ()=> addDigerTaskFrom('#digerTaskNew2');
            document.getElementById('btnReset').onclick = ()=>{ if(confirm('Tüm veriler silinsin mi?')){ localStorage.removeItem(LS_KEY); location.reload(); } };
            document.getElementById('btnAddPerson').onclick = ()=>{
                const v=$('#newPerson').value.trim();
                if(v && !state.people.includes(v)){ state.people.push(v); $('#newPerson').value=''; bumpMeta(); save(); renderAll(); schedulePush(); }
            };
            document.getElementById('btnAddType').onclick = ()=>{
                const v=$('#newType').value.trim();
                if(v && !state.types.includes(v)){ state.types.push(v); $('#newType').value=''; bumpMeta(); save(); renderAll(); schedulePush(); }
            };

            document.getElementById('btnExport').onclick = ()=>{
                const blob=new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
                const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gorev-takip.json'; a.click();
            };
            document.getElementById('btnImport').onclick = ()=> document.getElementById('fileImport').click();
            document.getElementById('fileImport').onchange = async (e)=>{
                const f=e.target.files[0]; if(!f) return;
                try{
                    const t=await f.text(); const data=JSON.parse(t);
                    if(!data.people || !data.types || !Array.isArray(data.records)) throw new Error('Şema hatalı');
                    state=data; state.__meta = state.__meta || {updatedAt:Date.now(), clientId: CLIENT_ID};
                    state.digerTasks = state.digerTasks || ["GOREV1","GOREV2"];
                    state.lastByOtherTask = state.lastByOtherTask || {};
                    save(); renderAll(); schedulePush();
                } catch(err){ alert('İçe aktarım hatası: '+err.message); }
            };
            document.querySelectorAll('#modeRadios input[name=mode]').forEach(r=> r.onchange = ()=>{ renderAll(); $('#btnSuggest').click(); });
            document.getElementById('tabSummary').onclick = ()=> setView('summary');
            document.getElementById('tabDiger').onclick = ()=> setView('diger');

            try { const c = JSON.parse(localStorage.getItem(LS_KEY + '__cloud') || '{}'); document.getElementById('cloudUrl').value = c.url || DEFAULT_WORKER; } catch { document.getElementById('cloudUrl').value = DEFAULT_WORKER; }

            renderAll(); initScorePicker();

            // ==== Bulut Senkron (v16 ile aynı davranış) ====
            let pushDebounce=null, pulling=false, lastSeenSha=null;
            function schedulePush(){
                if(pushDebounce) clearTimeout(pushDebounce);
                pushDebounce=setTimeout(async()=>{ try{ await cloudPush(); } catch(e){ console.warn('Senkron hatası:', e); } finally{ pushDebounce=null; } }, 600);
            }
            async function cloudPush(){
                const url=document.getElementById('cloudUrl').value.trim(); if(!url) return;
                const res=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data:state})});
                const j=await res.json(); if(!res.ok || !j.ok) throw new Error(j.error||'Buluta gönderilemedi'); return true;
            }
            async function cloudPull(){
                if(pulling) return; pulling=true;
                try{
                    const url=document.getElementById('cloudUrl').value.trim(); if(!url) return;
                    const res=await fetch(url,{cache:'no-store'}); const j=await res.json();
                    if(!res.ok || !j || !j.ok) return;
                    const cloud=j.data||{}, cloudSha=j.sha||null;
                    const localMeta=state.__meta||{updatedAt:0}, cloudMeta=cloud.__meta||{updatedAt:0};
                    if(cloudSha!==lastSeenSha && (cloudMeta.updatedAt>localMeta.updatedAt)){
                        state=cloud; state.__meta = state.__meta || {updatedAt:Date.now(), clientId: CLIENT_ID};
                        state.digerTasks = state.digerTasks || ["GOREV1","GOREV2"];
                        state.lastByOtherTask = state.lastByOtherTask || {};
                        save(); renderAll();
                    }
                    lastSeenSha=cloudSha;
                } finally { pulling=false; }
            }
            cloudPull(); setInterval(cloudPull, 10000);
            document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') cloudPull(); });
            window.addEventListener('online', cloudPull);
            document.getElementById('cloudUrl').addEventListener('change', ()=>{
                localStorage.setItem(LS_KEY + '__cloud', JSON.stringify({url: document.getElementById('cloudUrl').value.trim()}));
                cloudPull();
            });

            if('serviceWorker' in navigator){
                window.addEventListener('load', async ()=>{
                    try{
                        const reg = await navigator.serviceWorker.register('./sw.js', {scope:'./'});
                        reg.addEventListener('updatefound', ()=>{
                            const sw=reg.installing; if(!sw) return;
                            sw.addEventListener('statechange', ()=>{
                                if(sw.state==='installed' && reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
                            });
                        });
                        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
                            if(!window.__reloadedBySW){ window.__reloadedBySW=true; location.reload(); }
                        });
                        reg.update().catch(()=>{});
                    } catch(e){ console.warn('SW kayıt hatası:', e); }
                });
            }
        })();
        </script>
    </body>
</html>



