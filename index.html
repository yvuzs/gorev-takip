<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Görev Takibi (PWA + Otomatik Senkron)</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- no-cache (geliştirme akıcı olsun) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --chip:#1f2937; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#e5e7eb}

  /* App shell */
  .appbar{
    position:sticky; top:0; z-index:20;
    padding: calc(env(safe-area-inset-top) + 10px) 16px 12px;
    background:rgba(8,12,20,.8); backdrop-filter: saturate(120%) blur(6px);
    border-bottom:1px solid #1f2937;
  }
  .appbar h1{margin:0; font-size:18px; letter-spacing:.2px; font-weight:800; text-align:center}
  .wrap{max-width:1200px;margin:auto;padding:16px 16px 80px} /* altta bottom bar için boşluk */

  h2{margin: 6px 0 12px;}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  label{display:block;margin:10px 0 6px;color:#cbd5e1;font-weight:600}
  input[type=text],input[type=date],select{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;text-align:center}
  textarea{width:100%;min-height:70px;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  .row{display:flex;gap:8px;align-items:center}
  .row>*{flex:1}
  .btn{padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;cursor:pointer;text-align:center}
  .btn.small{padding:6px 10px;font-size:12px;border-radius:8px}
  .btn:hover{filter:brightness(1.12)}
  .btn-prim{background:linear-gradient(135deg,var(--accent2),#06b6d4);border:0;color:white}
  .btn-good{background:linear-gradient(135deg,var(--accent),#16a34a);border:0;color:white}
  .btn-danger{background:linear-gradient(135deg,#ef4444,#f97316);border:0;color:white}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:var(--chip);border:1px solid #334155}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;text-align:center}
  th,td{padding:8px 10px;border-bottom:1px solid #1f2937;vertical-align:middle;text-align:center}
  th{position:sticky;top:0;background:#0b1220;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
  tbody tr:hover{background:#0b1220}
  .kbadge{font-weight:700;padding:2px 6px;border-radius:8px;background:#1e293b;display:inline-block}
  .pill{padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #334155;display:inline-block}
  .stack{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .small{font-size:12px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  details{border:1px dashed #334155;border-radius:12px;padding:10px}
  summary{cursor:pointer;color:#93c5fd}
  .score-picker{display:flex;gap:6px;justify-content:center;margin-top:6px}
  .score-box{width:40px;height:24px;border-radius:6px;border:1px solid #444;cursor:pointer;opacity:.85;transition:transform .12s, opacity .12s, box-shadow .12s}
  .score-box:hover{opacity:1;transform:translateY(-1px)}
  .score-box.active{box-shadow:0 0 0 2px #fff inset;opacity:1;transform:translateY(-1px)}
  .score-label{display:block;margin-top:6px;text-align:center;color:#cbd5e1}

  /* Bottom action bar (sadece mobilde görünür) */
  .bottombar{
    position:fixed; left:0; right:0; bottom:0; z-index:30;
    padding: 10px 16px calc(env(safe-area-inset-bottom) + 10px);
    background:rgba(8,12,20,.95); backdrop-filter: saturate(120%) blur(6px);
    border-top:1px solid #1f2937;
    display:none; gap:8px;
  }
  .bottombar .btn{flex:1; font-size:15px; padding:14px; border-radius:12px}

  @media (max-width: 900px){
    .grid{grid-template-columns:1fr}
    .wrap{padding:12px 12px 90px}
    .card{padding:14px}
    th,td{padding:10px 8px}
    .bottombar{display:flex}
    /* formdaki ana iki butonu mobilde gizle, alttaki barı kullan */
    #btnSuggest, #btnAdd { display:none; }
  }
</style>
</head>
<body>
  <!-- APP BAR (sadece üst başlık) -->
  <div class="appbar"><h1>Görev Takibi</h1></div>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h2>Yeni Kayıt</h2>
        <div class="row">
          <div>
            <label>Görev Türü</label>
            <select id="taskType"></select>
          </div>
          <div>
            <label>Kişi <span class="muted small" id="suggestHint"></span></label>
            <select id="personSelect"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Başlangıç Tarihi</label>
            <input id="startDate" type="date" />
          </div>
          <div>
            <label>Bitiş Tarihi (opsiyonel)</label>
            <input id="endDate" type="date" />
          </div>
        </div>

        <div id="otherWrap" style="display:none">
          <label>Diğer Görev Puanı (1–5) & Açıklama</label>
          <div class="score-picker" id="scorePicker">
            <div class="score-box" data-val="1" style="background:#fff7b2"></div>
            <div class="score-box" data-val="2" style="background:#ffe44d"></div>
            <div class="score-box" data-val="3" style="background:#ffd32d"></div>
            <div class="score-box" data-val="4" style="background:#ffa64d"></div>
            <div class="score-box" data-val="5" style="background:#e82929"></div>
          </div>
          <span class="score-label" id="scoreLabel">Seçili: 1</span>
          <input id="pointsInput" type="hidden" value="1" />
          <div class="row" style="margin-top:8px">
            <input id="noteInput" type="text" placeholder="Açıklama (ör. eğitim desteği, evrak dağıtımı...)" />
          </div>
        </div>

        <label>Atama Stratejisi</label>
        <div class="stack small" id="modeRadios">
          <label class="chip"><input type="radio" name="mode" value="rr"> Round-Robin</label>
          <label class="chip"><input type="radio" name="mode" value="min" checked> En az görev yapan</label>
          <label class="chip"><input type="radio" name="mode" value="idle"> En uzun süredir görev almayan</label>
        </div>

        <div class="row">
          <button class="btn btn-good" id="btnSuggest">Sıradaki Öner</button>
          <button class="btn btn-prim" id="btnAdd">Kaydı Ekle</button>
        </div>

        <details>
          <summary>Personel ve Tür Listeleri</summary>
          <div class="row"><input id="newPerson" type="text" placeholder="Yeni personel adı" /><button class="btn" id="btnAddPerson">Ekle</button></div>
          <div class="stack" id="peopleChips"></div>
          <label>Görev Türleri</label>
          <div class="stack" id="typeChips"></div>
          <div class="row"><input id="newType" type="text" placeholder="Yeni tür (ör. GAMER)" /><button class="btn" id="btnAddType">Ekle</button></div>
        </details>

        <details open>
          <summary>Bulut Ayarı</summary>
          <label>Cloudflare Worker URL</label>
          <input id="cloudUrl" type="text" placeholder="https://<worker-adresin>.workers.dev/"/>
          <p class="muted small">Değişiklikler otomatik olarak buluta gönderilir ve arka planda çekilir.</p>
        </details>

        <div class="row">
          <button class="btn" id="btnExport">Dışa Aktar (JSON)</button>
          <button class="btn" id="btnImport">İçe Aktar</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none" />
        </div>
        <div class="right"><button class="btn btn-danger" id="btnReset">Tüm Veriyi Sıfırla</button></div>
      </div>

      <div class="card">
        <h2 style="text-align:center">Özet Tablo</h2>
        <div id="summaryWrap" style="overflow:auto; max-height:420px"><table id="summaryTable"></table></div>
        <h3 style="text-align:center">Kayıtlar</h3>
        <div id="logWrap" style="overflow:auto; max-height:260px"><table id="logTable"></table></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM ACTION BAR (mobil) -->
  <div class="bottombar">
    <button class="btn btn-good" id="mobileSuggest">Sıradaki Öner</button>
    <button class="btn btn-prim" id="mobileAdd">Kaydı Ekle</button>
  </div>

<script>
(function(){
  /* ===== Helpers & IDs ===== */
  const LS_KEY='gorevTakip_v9';
  const OTHER_TYPE='DIGER';
  const daysWeighted=new Set(["112-HABER MERKEZI","GAMER"]);
  const $=s=>document.querySelector(s);
  const today=()=>new Date().toISOString().slice(0,10);
  const DEFAULT_WORKER='https://blue-violet-32c9.retkitselim.workers.dev/';

  // client id
  function ensureClientId(){
    let id=localStorage.getItem(LS_KEY+'__clientId');
    if(!id){ id='c-'+Math.random().toString(36).slice(2)+Date.now(); localStorage.setItem(LS_KEY+'__clientId',id); }
    return id;
  }
  const CLIENT_ID=ensureClientId();

  /* ===== State ===== */
  let state;
  try{ state=JSON.parse(localStorage.getItem(LS_KEY)||'null') }catch{ state=null }
  if(!state){
    state={ people:["ATAL","KAVAKLI","YAMAN","AKSU","GORMEZ","TURGAY","ERDIK"],
            types:["112-HABER MERKEZI","GAMER","MAC","GOCMEN","DIGER"],
            records:[], lastByType:{}, __meta:{updatedAt:Date.now(), clientId:CLIENT_ID} };
  } else {
    state.__meta=state.__meta||{updatedAt:Date.now(),clientId:CLIENT_ID};
  }
  const save=()=>localStorage.setItem(LS_KEY,JSON.stringify(state));
  const bumpMeta=()=>{ state.__meta={updatedAt:Date.now(),clientId:CLIENT_ID}; };

  function weightOfRecord(r){
    if(daysWeighted.has(r.type)) return Math.max(1, Number(r.days)||1);
    if(r.type===OTHER_TYPE)   return Math.max(1, Math.min(5, Number(r.points)||1));
    return 1;
  }
  function countsBy(type){
    const m=new Map(state.people.map(p=>[p,0]));
    state.records.forEach(r=>{ if(!type||r.type===type){ m.set(r.person,(m.get(r.person)||0)+weightOfRecord(r)); }});
    return m;
  }
  function lastTimeBy(type){
    const m=new Map(state.people.map(p=>[p,0]));
    state.records.forEach(r=>{ if(!type||r.type===type){ const t=new Date(r.start).getTime(); if(t>m.get(r.person)) m.set(r.person,t); }});
    return m;
  }
  function nextRR(type){
    const list=state.people;if(!list.length)return null;
    const last=state.lastByType[type]; let idx=last?list.indexOf(last):-1;
    return list[(idx+1)%list.length];
  }
  function nextMin(type){
    const c=countsBy(type); let best=null,bv=Infinity;
    for(const p of state.people){ const v=c.get(p)||0; if(v<bv){best=p;bv=v;} }
    return best;
  }
  function nextIdle(type){
    const m=lastTimeBy(type); let best=null,bv=Infinity;
    for(const p of state.people){ const v=m.get(p)||0; if(v<bv){best=p;bv=v;} }
    return best;
  }
  function suggest(type){
    if(type===OTHER_TYPE) return nextMin(type);
    const mode=document.querySelector('input[name=mode]:checked').value;
    if(mode==='rr')   return nextRR(type);
    if(mode==='idle') return nextIdle(type);
    return nextMin(type);
  }

  function toggleOtherInputs(){
    const show=$('#taskType').value===OTHER_TYPE;
    $('#otherWrap').style.display= show? 'block':'none';
  }
  function initScorePicker(){
    const boxes=document.querySelectorAll('#scorePicker .score-box');
    const hidden=$('#pointsInput'), label=$('#scoreLabel');
    boxes.forEach(b=>{
      b.onclick=()=>{
        boxes.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        hidden.value=b.dataset.val; label.textContent='Seçili: '+hidden.value;
      };
    });
    (boxes[0]||{}).click?.();
  }

  /* ===== Render ===== */
  function render(){
    localStorage.setItem(LS_KEY+'__cloud', JSON.stringify({url: $('#cloudUrl')?.value||''}));
    $('#taskType').innerHTML=state.types.map(t=>`<option>${t}</option>`).join('');
    $('#personSelect').innerHTML=state.people.map(p=>`<option>${p}</option>`).join('');
    if(!$('#startDate').value) $('#startDate').value=today();
    toggleOtherInputs();

    const types=state.types; const tbl=$('#summaryTable');
    const head='<thead><tr><th><span class="pill">PERSONEL</span></th>'+types.map(t=>`<th><span class="pill">${t}</span></th>`).join('')+'<th><span class="pill">TOPLAM</span></th></tr></thead>';
    const siraCells=types.map(t=>`<td><span class="pill">${suggest(t)||'-'}</span></td>`).join('');
    const siraRow=`<tr><td class="muted small">Sıra</td>${siraCells}<td></td></tr>`;

    /* toplam azdan çoğa sıralama */
    const rows = state.people
      .map(p => {
        const cells = types.map(t => countsBy(t).get(p) || 0);
        const tot = cells.reduce((a, b) => a + b, 0);
        return { p, cells, tot };
      })
      .sort((a, b) => a.tot - b.tot)
      .map(obj =>
        `<tr><td><span class="kbadge">${obj.p}</span></td>${obj.cells.map(c => `<td>${c}</td>`).join('')}<td><b>${obj.tot}</b></td></tr>`
      )
      .join('');

    tbl.innerHTML=head+'<tbody>'+siraRow+rows+'</tbody>';

    const pc=$('#peopleChips'); pc.innerHTML='';
    state.people.forEach(p=>{
      const w=document.createElement('span'); w.className='chip';
      w.innerHTML=`<span>${p}</span>`;
      const d=document.createElement('button'); d.className='btn small'; d.textContent='Sil';
      d.onclick=()=>{ if(!confirm(`${p} silinsin mi?`)) return;
        state.people=state.people.filter(x=>x!==p); bumpMeta(); save(); render(); schedulePush();
      };
      w.appendChild(d); pc.appendChild(w);
    });

    const tc=$('#typeChips'); tc.innerHTML='';
    state.types.forEach(t=>{
      const w=document.createElement('span'); w.className='chip';
      w.innerHTML=`<span>${t}</span>`;
      const d=document.createElement('button'); d.className='btn small'; d.textContent='Sil';
      d.onclick=()=>{ if(state.types.length<=1) return alert('En az bir tür kalmalı.');
        if(!confirm(`${t} silinsin mi?`)) return;
        state.types=state.types.filter(x=>x!==t); bumpMeta(); save(); render(); schedulePush();
      };
      w.appendChild(d); tc.appendChild(w);
    });

    const log=$('#logTable');
    log.innerHTML='<thead><tr><th><span class="pill">BAŞLANGIÇ</span></th><th><span class="pill">BİTİŞ</span></th><th><span class="pill">TÜR</span></th><th><span class="pill">KİŞİ</span></th><th><span class="pill">PUAN</span></th><th><span class="pill">AÇIKLAMA</span></th><th></th></tr></thead><tbody>'+
      state.records.slice().reverse().map((r,i)=>{
        const idx=state.records.length-1-i;
        const p=(r.type===OTHER_TYPE)?(r.points||''):'';
        const note=(r.type===OTHER_TYPE)?(r.note||''):'';
        return `<tr><td>${r.start}</td><td>${r.end}</td><td>${r.type}</td><td>${r.person}</td><td>${p}</td><td>${note}</td>
          <td><button class="btn small" data-del="${idx}">Sil</button></td></tr>`;
      }).join('')+'</tbody>';
    log.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{
      const idx=+b.getAttribute('data-del');
      state.records.splice(idx,1); bumpMeta(); save(); render(); schedulePush();
    });
  }

  /* ===== Actions ===== */
  $('#taskType').onchange=()=>{ toggleOtherInputs(); $('#btnSuggest').click(); };
  $('#btnSuggest').onclick=()=>{ const t=$('#taskType').value; const p=suggest(t); $('#suggestHint').textContent=p?`(öneri: ${p})`:''; if(p) $('#personSelect').value=p; };
  $('#btnAdd').onclick=addRecord;

  // Bottom bar butonları aynı işlevleri tetikler
  $('#mobileSuggest').onclick=()=>$('#btnSuggest').click();
  $('#mobileAdd').onclick=()=>$('#btnAdd').click();

  function addRecord(){
    const type=$('#taskType').value, person=$('#personSelect').value;
    const s=$('#startDate').value, e=$('#endDate').value;
    if(!type||!person||!s) return alert('Eksik bilgi');
    let end=e;
    if(!end){ const d=new Date(s); d.setDate(d.getDate()+1); end=d.toISOString().slice(0,10); }
    let days=Math.ceil((new Date(end)-new Date(s))/86400000); if(days<1) days=1;
    const rec={type,person,start:s,end:end,days};
    if(type===OTHER_TYPE){
      rec.points=Math.max(1,Math.min(5,Number($('#pointsInput').value||'1')));
      rec.note=($('#noteInput').value||'').trim();
      $('#noteInput').value='';
    }
    state.records.push(rec);
    state.lastByType[type]=person;
    bumpMeta(); save(); render(); schedulePush();
  }

  $('#btnReset').onclick=()=>{ if(confirm('Tüm veriler silinsin mi?')){ localStorage.removeItem(LS_KEY); location.reload(); } };
  $('#btnAddPerson').onclick=()=>{ const v=$('#newPerson').value.trim();
    if(v&&!state.people.includes(v)){ state.people.push(v); $('#newPerson').value=''; bumpMeta(); save(); render(); schedulePush(); }
  };
  $('#btnAddType').onclick=()=>{ const v=$('#newType').value.trim();
    if(v&&!state.types.includes(v)){ state.types.push(v); $('#newType').value=''; bumpMeta(); save(); render(); schedulePush(); }
  };
  $('#btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gorev-takip.json'; a.click(); };
  $('#btnImport').onclick=()=>$('#fileImport').click();
  $('#fileImport').onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; try{
    const t=await f.text(); const data=JSON.parse(t);
    if(!data.people||!data.types||!Array.isArray(data.records)) throw new Error('Şema hatalı');
    state=data; state.__meta=state.__meta||{updatedAt:Date.now(),clientId:CLIENT_ID};
    save(); render(); schedulePush();
  }catch(err){ alert('İçe aktarım hatası: '+err.message); } };
  document.querySelectorAll('#modeRadios input[name=mode]').forEach(r=>r.onchange=()=>{ render(); $('#btnSuggest').click(); });

  // Bulut URL yükle
  try{ const c=JSON.parse(localStorage.getItem(LS_KEY+'__cloud')||'{}'); $('#cloudUrl').value=c.url||DEFAULT_WORKER; }catch{ $('#cloudUrl').value=DEFAULT_WORKER; }

  render(); initScorePicker();

  /* ===== Otomatik Bulut Senkron ===== */
  let pushDebounce=null, pulling=false, lastSeenSha=null;

  function schedulePush(){
    if(pushDebounce) clearTimeout(pushDebounce);
    pushDebounce=setTimeout(async()=>{
      try{ await cloudPush(); }catch(e){ console.warn('Senkron hatası:', e); }
      finally{ pushDebounce=null; }
    }, 600);
  }
  async function cloudPush(){
    const url=$('#cloudUrl').value.trim(); if(!url) return;
    const res=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ data: state }) });
    const j=await res.json(); if(!res.ok||!j.ok) throw new Error(j.error||'Buluta gönderilemedi');
    return true;
  }
  async function cloudPull(){
    if(pulling) return; pulling=true;
    try{
      const url=$('#cloudUrl').value.trim(); if(!url) return;
      const res=await fetch(url,{cache:'no-store'}); const j=await res.json();
      if(!res.ok||!j||!j.ok) return;
      const cloud=j.data||{}, cloudSha=j.sha||null;
      const localMeta=state.__meta||{updatedAt:0}, cloudMeta=cloud.__meta||{updatedAt:0};
      if(cloudSha!==lastSeenSha && (cloudMeta.updatedAt>localMeta.updatedAt)){
        state=cloud; state.__meta=state.__meta||{updatedAt:Date.now(),clientId:CLIENT_ID};
        save(); render();
      }
      lastSeenSha=cloudSha;
    }catch(e){} finally{ pulling=false; }
  }
  cloudPull(); setInterval(cloudPull,10000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') cloudPull(); });
  window.addEventListener('online', cloudPull);
  $('#cloudUrl').addEventListener('change', ()=>{ localStorage.setItem(LS_KEY+'__cloud', JSON.stringify({url: $('#cloudUrl').value.trim()})); cloudPull(); });

  /* ===== Service Worker: network-first HTML + auto reload ===== */
  if('serviceWorker' in navigator){
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./sw.js',{scope:'./'});
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!window.__reloadedBySW) { window.__reloadedBySW = true; location.reload(); }
        });
        reg.update().catch(()=>{});
      } catch (e) { console.warn('SW kayıt hatası:', e); }
    });
  }
})();
</script>
</body>
</html>
